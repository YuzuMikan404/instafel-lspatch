name: Auto Patch Instafel (Local Mode)

on:
  schedule:
    # 毎日 日本時間 午前4時 (UTC 19:00) にチェック
    - cron: '0 19 * * *'
  workflow_dispatch: # 手動実行用

permissions:
  contents: write

jobs:
  check-and-patch:
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリのチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Javaのセットアップ (LSPatchにはJava 21が必要)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3. Android SDKのセットアップ
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android Build Tools
        run: |
          yes | sdkmanager --licenses
          sdkmanager "build-tools;34.0.0" "platform-tools"

      # 4. 更新チェック
      - name: Check for updates
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Instafelの配布リポジトリ
          UPSTREAM_REPO: "mamiiblt/instafel"
        run: |
          # 最新のInstafelのタグを取得
          LATEST_TAG=$(gh release list --repo $UPSTREAM_REPO --limit 1 --json tagName --jq '.[0].tagName')
          echo "Upstream version: $LATEST_TAG"

          # 自分のリポジトリの最新リリースを取得
          CURRENT_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' || echo "")
          echo "Current local version: $CURRENT_TAG"

          if [ -z "$LATEST_TAG" ]; then
             echo "Error: Could not find upstream release."
             exit 1
          fi

          if [ "$LATEST_TAG" == "$CURRENT_TAG" ]; then
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "New version found!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "tag_name=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
          fi

      # 5. Instafel APKのダウンロード (Clone版の特定)
      - name: Download Instafel APK
        if: steps.check.outputs.update_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_REPO: ${{ steps.check.outputs.upstream_repo }}
          TAG_NAME: ${{ steps.check.outputs.tag_name }}
        run: |
          echo "Fetching asset list for $TAG_NAME..."
          
          ASSET_LIST=$(gh release view "$TAG_NAME" --repo "$UPSTREAM_REPO" --json assets --jq '.assets[].name | select(endswith(".apk"))')
          echo "Found assets:"
          echo "$ASSET_LIST"
          
          TARGET_FILE=$(echo "$ASSET_LIST" | grep "instafel_c_" | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "Warning: Clone version (instafel_c_) not explicitly found."
            echo "Falling back to the first available apk."
            TARGET_FILE=$(echo "$ASSET_LIST" | head -n 1)
          fi
          
          echo "Selected target file: $TARGET_FILE"
          
          gh release download "$TAG_NAME" --repo "$UPSTREAM_REPO" --pattern "$TARGET_FILE" --output "instafel.apk" --clobber
          ls -lh instafel.apk

      # 6. LSPatch (JingMatrix版) のダウンロード
      - name: Download LSPatch (JingMatrix)
        if: steps.check.outputs.update_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LSPATCH_REPO: "JingMatrix/LSPatch"
        run: |
          echo "Downloading latest LSPatch from $LSPATCH_REPO..."
          LATEST_LSPATCH_TAG=$(gh release list --repo $LSPATCH_REPO --limit 1 --json tagName --jq '.[0].tagName')
          gh release download "$LATEST_LSPATCH_TAG" --repo "$LSPATCH_REPO" --pattern "*.jar" --output "lspatch.jar" --clobber
          
          echo "LSPatch version: $LATEST_LSPATCH_TAG"

      # 7. パッチ適用 (ローカル適応モード)
      - name: Apply LSPatch (Local Mode)
        if: steps.check.outputs.update_needed == 'true'
        run: |
          mkdir -p output
          java -jar lspatch.jar instafel.apk -d -f -o output
          # パッチ適用後のファイルを一時的な名前に変更
          mv output/*.apk output/instafel-patched-unsigned.apk

      # 8. 署名 (apksignerを直接使用)
      # エラーが出ていたアクションを使わず、コマンドで直接署名します
      - name: Sign APK (Manual)
        if: steps.check.outputs.update_needed == 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          BUILD_TOOLS_VERSION: "34.0.0"
        run: |
          # ツールパスの設定
          BUILD_TOOLS_PATH="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION"
          
          # Keystoreをファイルに復元
          echo "$KEYSTORE_BASE64" | base64 -d > release.keystore
          
          # Zipalign (最適化)
          echo "Running zipalign..."
          "$BUILD_TOOLS_PATH/zipalign" -v -p 4 output/instafel-patched-unsigned.apk output/instafel-aligned.apk
          
          # 署名実行 (apksigner)
          echo "Running apksigner..."
          "$BUILD_TOOLS_PATH/apksigner" sign \
            --ks release.keystore \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass "pass:$STORE_PASSWORD" \
            --key-pass "pass:$KEY_PASSWORD" \
            --out output/instafel-patched.apk \
            output/instafel-aligned.apk
            
          # クリーンアップ
          rm release.keystore

      # 9. リリース作成
      - name: Create Release
        if: steps.check.outputs.update_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.check.outputs.tag_name }}" \
            output/instafel-patched.apk \
            --title "Instafel Patched ${{ steps.check.outputs.tag_name }}" \
            --notes "Base: Instafel Clone (c) ${{ steps.check.outputs.tag_name }}<br>LSPatch: JingMatrix Version (Local Mode)"
